var hasPadAccess = require("ep_etherpad-lite/node/padaccess");
var settings = require('ep_etherpad-lite/node/utils/Settings');
var exportHandler = require('ep_etherpad-lite/node/handler/ExportHandler');
var importHandler = require('ep_etherpad-lite/node/handler/ImportHandler');

exports.expressCreateServer = function (hook_name, args, cb) {
  args.app.get('/p/:pad/:rev?/export/:type', function(req, res, next) {
    var types = ["pdf", "doc", "txt", "html", "odt", "etherpad"];
	console.info("hook_name "+hook_name);
	console.info("args "+args);
	console.info("cb "+cb);
    //send a 404 if we don't support this filetype
    if (types.indexOf(req.params.type) == -1) {
      next();
      return;
    }
console.info("oming here ");
    //if abiword is disabled, and this is a format we only support with abiword, output a message
    if (settings.abiword == null &&
       ["odt", "pdf", "doc"].indexOf(req.params.type) !== -1) {
		console.info("Abiword is not enabled at this Etherpad instance. Set the path to Abiword in settings.json to enable this feature" );
      res.send("Abiword is not enabled at this Etherpad instance. Set the path to Abiword in settings.json to enable this feature");
      return;
    }

    res.header("Access-Control-Allow-Origin", "*");

    hasPadAccess(req, res, function() {
      exportHandler.doExport(req, res, req.params.pad, req.params.type);
    });
  });

  //handle import requests
  args.app.post('/p/:pad/import', function(req, res, next) {
    hasPadAccess(req, res, function() {
     console.info("COMING TO IMPORT......");
     console.info(req.params.pad);
     console.info(req);
     console.info(res);
      importHandler.doImport(req, res, req.params.pad);
    });
  });
}
